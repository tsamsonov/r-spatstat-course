# Точечные паттерны {#points}

```{r setup-ppp, echo = FALSE, purl = FALSE, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, collapse = TRUE, out.width = '100%')
```

## Краткий обзор {#review}

Для просмотра презентации щелкните на ней один раз левой кнопкой мыши и листайте, используя кнопки на клавиатуре:

```{r, echo=FALSE}
knitr::include_url('https://tsamsonov.github.io/r-spatstat-course-slides/04-PointPatterns_slides.html#1', height = '390px')
```

> Презентацию можно открыть в отдельном окне или вкладке браузере. Для этого щелкните по ней правой кнопкой мыши и выберите соответствующую команду.

```{r setup-patterns, include=FALSE}
library(tidyverse)
library(raster)
library(spatstat)
library(stars)
library(tmap)
library(sf)
library(sp)
```

## Точечный паттерн

__Точечный паттерн__ _(point pattern)_ представляет собой множество точек в $\mathbb{R}^2$, обозначаемое _малой_ жирной буквой:

$$\mathbf{x} = \{x_1, x_2,...x_n\}$$
- Количество точек $n = n(\mathbf{x})$ может быть любым неотрицательным числом

- Множество является неупорядоченным (индексы чисто условны)

- Допускаются дубликаты (совпадающие точки), однако большинство методов рассчитаны на то, что дубликатов в множестве нет.

Если $\mathbf{x}$ представляет точечный паттерн и $B$ — это некий регион, то $\mathbf{x} \cap B$ есть подмножество $\mathbf{x}$, состоящее из точек, попадающих в $B$:

![Baddeley et. al., 2016](images/pregion.png)

В данном случае количество точек, попадающих в $B$, равняется  $n = n(\mathbf{x} \cap B)$

## Точечные процессы

> __ Точечным процессом__ называется случайный процесс, реализациями которого являются точечные паттерны

__Конечный точечный процесс__ _(finite point process)_ — это точечный процесс, каждая реализация которого представляет собой точечный паттерн с конечным числом точек. При этом для любой области $B$ количество точек $\mathbf{x} \cap B$ представляет собой случайную величину с определимыми параметрами.

__Локально конечный точечный процесс__ имеет конечное число точек в любой ограниченной области $B$ (более мягкое утверждение). Реализацией такого процесса является _локально конечный точечный паттерн_.

### Равномерно случайные точки

Простейшим точечныйм процессом является процесс $U = (U_1, U_2)$, каждая реализация которого включает одну точку $u = (u_1, u_2)$. 

Случайная точка будет _равномерно_ распределена в пространственной облсти $W$, если ее координаты $(U_1, U_2)$ имеют совместную плотность распределения, которая постоянна в пределах $W$ и равна нулю за ее пределами. 

Поскольку интеграл плотности распределения равен 1, величина постоянной будет равна $1/|W|$:

$$f(u_1, u_2) = \begin{cases}
  1/|W|,~\text{если}~(u_1, u_2) \in W\\
  0, ~\text{в противном случае}
\end{cases}$$

Если $B$ представляет собой тестовую область в $W$, то вероятность того, что точка $U$ попадет в $B$, будет равна:

$$\mathbb{P}\{U \in B \} = \int_B f(u_1, u_2) du_1 du_2 = \\ = \frac{1}{|W|} \int_B 1 du_1 du_2 = \frac{|B|}{|W|}$$
- эта вероятность равна доле площади $B$ в $W$

- вероятность зависит только от площади, и не зависит от положения и формы области $B$ 

### Биномиальный точечный процесс

__Биномиальным__ называется точечный процесс $\mathbf{X} = \{X_1,..., X_n\}$, реализации которого содержат $n$ точек.

![Baddeley et. al., 2016](images/pbinomial.png)

Чтобы точки были распределены равномерно по пространству, необходимо выполнение двух условий:

- $X_1,...,X_n$ представляют собой _независимые_ случайные величины
- Каждая из этих величин _равномерно_ распределена в пределах $W$.

Если $B$ представляет собой тестовую область, то количество $n(\mathbf{X} \cap B)$ случайных точек, попавших в $B$, будет равняться количеству индексов $i$ таких, что $X_i \in B$.

Чтобы определить вероятностное распределение $n(\mathbf{X} \cap B)$, рассмотрим эту величину как количество успешных исходов в $n$ независимых испытаниях. Будем считать «успехом» исход, при котором случайная точка $X_i$ попадает в $B$. 

Если испытания независимы и равномерно распределены, то вероятность успеха равна $p = |B| / |W|$ и величина  $n(\mathbf{X} \cap B)$ имеет _биномиальный закон распределения_:

$$\mathbb{P}\{n(\mathbf{X} \cap B) = k\} = 
  \left(
    \begin{array}{c}
      n \\
      k
    \end{array}
  \right) p^k (1-p)^{n-k}\color{grey}{, k = 0, 1, ..., n}$$
  
Биномиальный коэффициент равен числу сочетаний из $n$ по $k$ (без учета порядка):
$$\left(
    \begin{array}{c}
      n \\
      k
    \end{array}
  \right) = \frac{n!}{(n-k)!~k!}$$

### Пуассоновский процесс

__Однородный пуассоновский точечный процесс__ (homogeneous Poisson point process), или _абсолютная пространственная случайность_ (complete spatial randomness — CSR) характеризуется следующими свойствами:

- __гомогенность__: размещение точек не имеет пространственных закономерностей
- __независимость__: результат реализации процесса в одной области не оказывает влияние на результат реализации в других областях

![Baddeley et. al., 2016](images/ppoisson.png)

__Однородность__ _(гомогенность)_ означает, что ожидаемое количество точек, попадающих в регион $B$ должно быть пропорционально его площади:

$$\operatorname E[n(\mathbf{X} \cap B)] = \lambda |B|$$
Параметр $\lambda$ представляет собой среднее количество точек на единицу площади — __интенсивность точечного процесса__.

> В отличие от биномиального процесса, полностью случайный (Пуассоновский) процесс характеризуется _случайным количеством точек_.

__Пространственная независимость__ означает, что количества точек в двух неперекрывающихся областях $A$ и $B$ являются независимыми случайными переменными:

$$n(\mathbf{X} \cap A) \not\sim n(\mathbf{X} \cap B),~A \cap B = \emptyset$$
> Для биномиального процесса условие независимости не выполняется, поскольку известно общее количество точек. Если в область $A$ попало $k$ точек, то в область $B$ не может попасть более чем $n-k$ точек, что нарушает условие независимости распределений.

Предположение о независимости выполняется для любых непересекающихся регионов $A$ и $B$ и для любого числа этих регионов

Одним из следствий независимости является тот факт, что количество точек, подсчитанное по _регулярной сетке квадратов_, также даст совокупность независимых величин (для любого размера сетки):

![Baddeley et. al., 2016](images/qcounts.png)

__Упорядоченность__ _(orderliness)_: при стремлении площади области к нулю, вероятность нахождения в этой области более одной точки, деленная на площадь, также стремится к нулю

![Baddeley et. al., 2016](images/smalltrials.png)

Если реализации отвечают условию независимости и вероятность нахождения более одной точки в бесконечно малом квадрате пренебрежимо мала, то случайную величину $n(\mathbf{X} \cap B)$ можно рассматривать как _количество «успехов» в большом числе независимых испытаний, каждое из которых имеет малую вероятность успеха_.

Это означает, что $n(\mathbf{X} \cap B)$ подчиняется __распределению Пуассона__, которое характеризует _частоту редких событий_.

В соответствии с этим законом, вероятность получить $k$ редких событий равна

$$\mathbb{P}\{N = k\} = e^{-\mu} \frac{\mu^k}{k!}\color{grey}{,~k = 0, 1, 2, ...}$$

Величина $\mu$ представляет собой _математическое ожидание_ распределения Пуассона. 

> Дисперсия распределения Пуассона равна его математическому ожиданию

Поскольку, как мы показали ранее, ожидаемое количество точек в регионе $B$ равняется $\operatorname E[n(\mathbf{X} \cap B)] = \lambda |B|$, можно сделать вывод, что случайная величина $n(\mathbf{X} \cap B)$ имеет распределение Пуассона с математическим ожиданием:

$$\mu = \lambda |B|$$

Пуассоновский процесс определяется следующими __параметрами__:

- __однородность__: количество $n(\mathbf{B} \cap B)$ случайных точек, попадающих в выборочную область $B$ характеризуется мат. ожиданием $\mathbb{E}n(\mathbf{X} \cap B) = \lambda |B|$; 

- __независимость__: для неперекрывающихся выборочных областей $B_1, B_2, ..., B_k$, количества $n(\mathbf{X} \cap B_1), ..., n(\mathbf{X} \cap B_k)$ предствляют собой независимые случайные величины;

- __распределение Пуассона__: число $n(\mathbf{B} \cap B)$ случайных точек, попадающих в выборочную область $B$ распределено по закону Пуассона.

__Свойства__ пуассоновского процесса:

- __условность__ _(conditional)_: в любой области $B$ точки процесса независимо и равномерно распределены;

- __прореживаемость__ _(thinning)_: при случайном прореживании (отборе точек) пуассоновского точечного паттерна с интенсивностью $\lambda$ результирующий паттерн будет соответствовать Пуассоновскому процессу с интенсивностью $p\lambda$, где $p$ — вероятность сохранения точки (процент отбора);

    ![Baddeley et. al., 2016](images/pthinning.png)

- __суперпозиция__ _(superposition)_: сумма двух независимых гомогенных случайных точечных процессов $Z = X \cup Y$ с интенсивностями $\lambda_X$ и $\lambda_Y$ является гомогенным Пуассоновским процессом с интенсивностью $\lambda_Z = \lambda_X + \lambda_Y$

    ![Baddeley et. al., 2016](images/psuperposition.png)

#### Симуляция Пуассоновского процесса

Пусть дана область $B = [x_{min}, x_{max}] \times [y_{min}, y_{max}]$ и интенсивность точечного процесса $\lambda$.

1. Сгенерировать случайное число $N$, имеющее распределение Пуассона с параметром $\mu = \lambda |B|$.

2. Сгенерировать $N$ координат $X$, имеющих равномерное распределение на промежутке $[x_{min}, x_{max}]$.

3. Сгенерировать $N$ координат $Y$, имеющих равномерное распределение на промежутке $[y_{min}, y_{max}]$.

> Вероятность получить 0 точек также существует и равна $\mathbb{P}\{N = 0\} = e^{-\mu} \frac{\mu^0}{0!} = e^{-\lambda |B|}$


### Неоднородный пуассоновский процесс

Определяется следующими параметрами:

- __функция интенсивности__: количество $n(\mathbf{X} \cap B)$ случайных точек, попадающих в выборочную область $B$ характеризуется мат. ожиданием $\mathbb{E}n(\mathbf{X} \cap B) = \int_B \lambda(u) du = \mu$, где $\lambda(u)$ есть пространственная функция интенсивности; 

- __независимость__: для неперекрывающихся выборочных областей $B_1, B_2, ..., B_k$, количества $n(\mathbf{X} \cap B_1), ..., n(\mathbf{X} \cap B_k)$ предствляют собой независимые случайные величины;

- __распределение Пуассона__: число $n(\mathbf{B} \cap B)$ случайных точек, попадающих в выборочную область $B$ распределено по закону Пуассона.

Данные параметры отличаются следующими свойствами:

- функция плотности $\lambda(u)$ определяет общее количество точек и их пространственное распределение;

- никаких ограничений на функцию $\lambda(u)$ не накладывается, вследствие этого модель неоднородного Пуассоновского процесса является достаточно общей;

- свойства условности, прореживаемости и суперпозиции справедливы также и для неоднородного пуассоновского процесса;

#### Симуляция неоднородного пуассоновского процесса

Метод _Льюиса-Шедлера_ (Lewis-Shedler thinning):

1. Генерируется однородный Пуассоновской процесс с интенсивностью $M = \max_L\big[\lambda(u)\big]$.

2. Осуществляется случайное прореживание (исключение) точек с вероятностью сохранения точки $p(u) = \lambda(u) / M$, пропорциональной функции интенсивности.

Чтобы понять, будет ли точка исключена, генерируется случайное число 0 или 1, имющее распределени Бернулли с вероятностью положительного исхода $p = p(u)$. Это можно сделать с помощью функции `rbinom(1, 1, p)`

$$\lambda(x,y) = x + y^2$$

```{r, echo = FALSE, fig.width=10, fig.height=5, dpi=300}
lambda = function(x,y) { 500 * (y^2 + x) }

U = rpoispp(lambda, win=square(1))

par(mfrow = c(1,2))
plot(U, pch = 20)
plot(density(U))
```

### Процесс Кокса (Cox process)

Процесс Кокса определяется как Пуассоновский процесс со случайной функцией интенсивности $\Lambda(u)$, которая называется _порождающей интенсивностью_

![Baddeley et. al., 2016](images/cox.png)

Слева — реализация случайной функции $\Lambda(u)$. По центру — реализация Пуассоновского точечного процесса с интенсивностью $\Lambda(u)$.

- __Cмешанный Пуассоновский процесс__: однородный Пуассоновский процесс, порождаемый постоянной случайной величиной $\Lambda$. Интенсивность процесса равна $\lambda = \mathbb E\Lambda$.

- __Логнормальный процесс Кокса__: процесс Кокса с порождающей интенсивностью, равной $\Lambda(u) = \exp\big[G(u)\big]$, где $G(u)$ — Гауссовское случайное поле.

Для _гауссовского случайного поля_ в каждой точке $u_i$ случайная величина $G(u_i)$ имеет нормальное распределение, для пары точек $u$ и $v$ пара величин $\big(G(u), G(v)\big)$ имеет двумерное нормальное распределение. Аналогично и для произвольного числа точек.

Независимые реализации логнормального процесса Кокса:

![Baddeley et. al., 2016](images/coxnormal.png)

### Кластерные процессы

1. Генерируется «родительский» точечный процесс $\mathbf{Y}$.

2. Каждая точка родительского процесса $y_i$ порождает случайный точечный паттерн «потомков» $x_{ij}$

![Baddeley et. al., 2016](images/clustered.png)

— Наблюдаются только точки потомков (каждая родительская точка замещается ее потомками).

— Множество точек $x_{ij}$ формирует реализацию кластерного точечного процесса $\mathbf{X}$.

![Baddeley et. al., 2016](images/clustered.png)

Возможные свойства кластерных процессов:

- (CLP1) __пуассоновские родители__: родительские точки являются реализацией Пуассоновского процесса.

- (CLP2) __независимые кластеры__: кластеры независимы друг от друга.

- (CLP3) __идентично распределенные кластеры__: если совместить разные кластеры, то они будут иметь одно распределение.

- (CLP4) __независимые потомки__: потомки внутри каждого кластера независимы и одинаково распределены.

Процессы, отвечающие требованиям (CLP1)—(CLP4) носят название процессов __Неймана-Скотта__ (_Neyman-Scott_).

- (CLP5) __пуассоновское количество потомков__: для каждой родительской точки количество потомков есть пуассоновская случайная величина.

- (CLP6) __изотропные кластеры__: плотность распределения потомков зависит только от расстояния до родительской точки.

Распространенные частные случаи:

- Процесс Матерна $(\kappa, \mu, r)$: процесс $Y$ имеет интенсивность $κ$, каждый родитель имеет $Π(μ)$ потомков, случайно распределенных в радиусе $r$

  Реализации процесса Матерна в квадрате $[0, 1] \times [0, 1]$ с интенсивностью родителей $\kappa = 8$, средним количеством потомков $\mu = 5$ и радиусом кластера $R = 0.1$:

  ![Baddeley et. al., 2016](images/matern.png)

- Процесс Томаса $(\kappa, \mu, \sigma)$: процесс $Y$ имеет интенсивность κ, каждый родитель имеет $Π(μ)$ потомков, смещенных на расстояние, подчиняющееся распределению $N(0,\sigma^2)$

### Регулярные процессы

Точки не могут располагаться на расстоянии ближе чем $r$ — __расстояния ингибиции__ (отталкивания).

- __Последовательные модели__: точки генерируются последовательно согласно Пуассоновскому распредедению (координаты равномерно распределены). Каждая последующая точка сохраняется, только если она находится на расстоянии не ближе, чем $r$.

- __Зависимое прореживание__: генерируется Пуассоновский процесс. После этого удаляются точки, расположенные на расстоянии меньшем $r$. Пары близко расположенных точек аннигилируют (_процесс Матерна I_). Либо точки маркируются случайным «временем прибытия» и удаляется точка, имеющая более позднее время прибытия (_процесс Матерна II_).

__Последовательная модель__:

![Baddeley et. al., 2016](images/rssi.png)

__Процесс Матерна I__:

![Baddeley et. al., 2016](images/matern1.png)

__Процесс Матерна II__:

![](images/matern2.png)

## Диагностика

В предыдущем разделе мы рассмотрели основные типы точечных процессов на плоскости, а также методы их симуляции в виде случайных распределений. В настоящем параграфе показаны различные методы, с помощью которых можно установить, к какому типу процессов относятся наблюдаемые в реальности точки.

### Анализ интенсивности

### Анализ зависимости

## Моделирование

Настоящий раздел посвящен подбору параметров модели точечного процесса для фактических данных о размещении объектов.

## Контрольные вопросы и упражнения {#questions_tasks_patterns}

### Вопросы {#questions_patterns}

1. Дайте определение точечного паттерна и точечного процесса.
1. Перечислите три основных типа точечных процессов.
1. Какими особенностями обладают конечный и локально конечный точечный процесс?
1. Каким уравнением опрпеделяется плотность распределения для равномерно случайного точечного процесса в области $W$? Чему будет равна вероятность попадания точки в подобласть $B$ этой области?
1. Сформулируйте определение биномиального точечного процесса. Какие условия должны выполняться для процесса данного типа?
1. Какими свойствами характеризуется однородный пуассоновский точечный процесс? Как эти свойства можно выразить математически?
1. Перечислите основные параметры пуассоновского точечного процесса.
1. Изложите алгоритм симуляции однородного пуассоновского точечного процесса. Назовите программные средства R, которые можно использовать для этого.
1. Чем неоднородный пуассоновский процесс отличается от однородного? Сформулируйте отличия словесно и математически.
1. Изложите алгоритм симуляции неоднородного пуассоновского точечного процесса по методу Льюиса-Шедлера. Назовите программные средства R, которые можно использовать для этого.
1. Дайте определение процессу Кокса. Приведите два примера частных случаев процесса Кокса.
1. Перечислите концептуальные принципы, лежащие в основе теории кластерных точечных процессов.
1. Назовите шесть основных свойств, с помощью которых определяется характер кластерного точечного процесса.
1. Какими свойствами обладают процессы Неймана-Скотта?
1. Дайте определение кластерных процессов Матерна и Томаса.
1. Какие программные средства имеются в среде R для анализа и симуляции кластерных точечных процессов?
1. Сформулируйте определение регулярного точечного процесса. Каков его основной параметр? Приведите примеры регулярных процессов в географической среде.
1. Назовите два типа моделей, используемых для представления регулярных точечных процессов. Изложите кратко используемые в них алгоритмы симуляции.
1. Перечислите основные статистические функции, используемые для анализа точечных паттернов.
1. Что из себя представляет индекс Моришита? Приведите формулу для его вычисления и раскройте суть каждой компоненты этой формулы.
1. В чем заключается преимущество K-функции Рипли в сравенении с другими методами оценки характера точечных паттернов?

### Упражнения {#tasks_patterns}

----
_Самсонов Т.Е._ **Пространственная статистика и моделирование на языке R.** М.: Географический факультет МГУ, `r lubridate::year(Sys.Date())`.
----